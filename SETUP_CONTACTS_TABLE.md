# Setting Up the Contacts Table in Supabase

This guide explains how to set up the contacts table in your Supabase database to properly handle contact form submissions.

## The Error

The error `Could not find the 'subject' column of 'contacts' in the schema cache` occurs because the contact form is trying to insert a message with a 'subject' field, but the database table doesn't have this column.

## Solution

### Step 1: Run the SQL Script

1. Go to your [Supabase Dashboard](https://app.supabase.io/)
2. Select your project
3. Go to the "SQL Editor" section
4. Create a new query
5. Copy and paste the contents of the `add_subject_to_contacts.sql` file:

```sql
-- If the contacts table doesn't exist, create it
CREATE TABLE IF NOT EXISTS public.contacts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  subject TEXT,
  message TEXT NOT NULL,
  responded BOOLEAN DEFAULT FALSE
);

-- Add subject column if it doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'contacts' 
        AND column_name = 'subject'
    ) THEN
        ALTER TABLE public.contacts ADD COLUMN subject TEXT;
    END IF;
END
$$;

-- Set up RLS for contacts table if it doesn't exist
ALTER TABLE public.contacts ENABLE ROW LEVEL SECURITY;

-- Create or replace policies for the contacts table
DO $$
BEGIN
    -- Drop policies if they exist (to avoid errors)
    DROP POLICY IF EXISTS "Public users can create contact messages" ON public.contacts;
    DROP POLICY IF EXISTS "Admins can read contact messages" ON public.contacts;
    DROP POLICY IF EXISTS "Admins can update contact messages" ON public.contacts;
    
    -- Create new policies
    CREATE POLICY "Public users can create contact messages" ON public.contacts FOR INSERT WITH CHECK (true);
    CREATE POLICY "Admins can read contact messages" ON public.contacts FOR SELECT TO authenticated USING (is_admin());
    CREATE POLICY "Admins can update contact messages" ON public.contacts FOR UPDATE TO authenticated USING (is_admin());
END
$$;
```

6. Click "Run" to execute the SQL

### Step 2: Verify the Table Structure

After running the SQL script, you should verify that the table was created correctly:

1. Go to the "Table Editor" section in your Supabase dashboard
2. Find the "contacts" table
3. Verify that it has the following columns:
   - id (primary key)
   - created_at (timestamp)
   - name (text)
   - email (text)
   - subject (text)
   - message (text)
   - responded (boolean)

### Step 3: Test the Contact Form

Once the table is set up correctly:

1. Go back to your website
2. Navigate to the Contact page
3. Fill out the contact form and submit it
4. Check if the form submission works without errors
5. Verify in the Supabase Table Editor that the message was saved correctly

### Step 4: Verify Admin Access

1. Log in as an admin user
2. Go to the Admin Dashboard
3. Navigate to Messages section
4. Verify that you can see the contact messages
5. Test marking a message as responded

## Understanding Row Level Security (RLS)

The SQL script sets up the following policies for the contacts table:

1. **Public users can create contact messages** - Anyone can submit a contact form
2. **Admins can read contact messages** - Only admin users can view messages
3. **Admins can update contact messages** - Only admin users can update messages (e.g., mark as responded)

This ensures that contact form submissions are secure while allowing administrators to manage them.

## Troubleshooting

### Error: "policy does not exist"

If you see an error like `ERROR: 42704: policy "Public users can create contact messages" for table "contacts" does not exist`, it means the script is trying to alter a policy that doesn't exist yet. The updated script above fixes this by dropping any existing policies and creating new ones from scratch. 